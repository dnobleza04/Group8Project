<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Employee Dashboard</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <style>
    :root {
      --deep-slate: #2D3E50;
      --bright-azure: #3498DB;
      --off-white: #EAF3FF;
      --card-border: #dce4ea;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: var(--off-white);
      color: var(--deep-slate);
      font-family: Arial, sans-serif;
      padding: 24px;
    }

    .topbar {
      max-width: 980px;
      margin: 0 auto 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    h1 { margin: 0; }

    .actions {
      display: flex;
      gap: 8px;
    }

    button {
      border: none;
      border-radius: 8px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
      background: var(--bright-azure);
      color: #fff;
    }

    #btnLogout {
      background: #e74c3c;
    }

    #voteLeftBtn {
      background: #dc2626;
    }

    #voteRightBtn {
      background: #16a34a;
    }

    #skipBtn {
      background: #6b7280;
    }

    .grid {
      max-width: 980px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    .card {
      background: #fff;
      border: 1px solid var(--card-border);
      border-radius: 10px;
      padding: 16px;
      box-shadow: 0 8px 18px rgba(45, 62, 80, 0.12);
    }

    .card h2 { margin: 0 0 10px; }

    textarea {
      width: 100%;
      border: 1px solid #d7dee3;
      border-radius: 8px;
      padding: 10px;
      resize: vertical;
    }

    #suggestionsCards .item {
      border: 1px solid #e1e8ed;
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
      background: #fff;
    }

    .small {
      font-size: 13px;
      color: #5f7286;
    }

    .subheader {
      margin: 0 0 10px;
      font-size: 14px;
      color: #5f7286;
    }

    .vote-actions {
      margin-top: 8px;
      display: flex;
      gap: 8px;
    }

    #progressText { margin-bottom: 10px; }

    #questionCard {
      min-height: 160px;
      border: 1px solid #d7dee3;
      border-radius: 8px;
      padding: 14px;
      background: #fff;
    }

    .vote-controls {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .msg {
      margin-top: 8px;
      min-height: 20px;
      font-size: 14px;
    }

    #errorMsg { color: #b00020; }
    #confirmMsg { color: #166534; }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>Dashboard</h1>
    <div class="actions">
      <button id="btnAdmin" type="button">Admin</button>
      <button id="btnLogout" type="button">Logout</button>
    </div>
  </div>

  <div class="grid" id="mainGrid">
    <section class="card" id="voteSection">
      <h2>Vote Here!</h2>
      <p class="subheader">Review and vote on site improvements submitted by employees and administrators.</p>
      <div id="progressText" class="small"></div>
      <div id="questionCard"></div>
      <div class="vote-controls">
        <button id="voteLeftBtn" type="button">Left</button>
        <button id="skipBtn" type="button">Skip</button>
        <button id="voteRightBtn" type="button">Right</button>
      </div>
      <div id="errorMsg" class="msg" style="display:none;"></div>
      <div id="confirmMsg" class="msg" style="display:none;"></div>
    </section>

    <section class="card" id="suggestionsSection">
      <h2>Suggestions</h2>
      <p class="subheader">Review community polls and employee feedback on recent suggestions.</p>
      <div id="suggestionsCards"></div>
    </section>

    <section class="card" id="feedbackSection">
      <h2>Anonymous Feedback</h2>
      <p class="subheader">Submit your own suggestions for workplace improvements here. (Optional)</p>
      <textarea id="suggestionText" rows="4" placeholder="Share your suggestion..."></textarea>
      <div style="margin-top:8px;">
        <button id="btnSubmitSuggestion" type="button">Submit</button>
      </div>
      <div id="suggestionMsg" class="msg"></div>
    </section>
  </div>

  <script src="voting.js"></script>
  <script>
    function apiUrl(method) {
      return "/ProjectServices.asmx/" + method;
    }

    function escapeHtml(text) {
      return String(text)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function redirectToLogin() {
      window.location.href = "login.html";
    }

    function showAccessDenied() {
      document.body.innerHTML = "<h1 style='font-family:Arial,sans-serif;text-align:center;margin-top:40px;'>Access Denied</h1>";
    }

    function enforceSectionOrder() {
      const grid = document.getElementById("mainGrid");
      if (!grid) {
        return;
      }

      const vote = document.getElementById("voteSection");
      const suggestions = document.getElementById("suggestionsSection");
      const feedback = document.getElementById("feedbackSection");

      if (vote) {
        grid.appendChild(vote);
      }
      if (suggestions) {
        grid.appendChild(suggestions);
      }
      if (feedback) {
        grid.appendChild(feedback);
      }
    }

    function loadSuggestions() {
      $.ajax({
        type: "POST",
        url: apiUrl("GetSuggestions"),
        contentType: "application/json; charset=utf-8",
        data: "{}",
        dataType: "json",
        success: function (res) {
          if (!res || typeof res.d === "undefined") {
            $("#suggestionsCards").html("<p>Unable to load suggestions.</p>");
            return;
          }

          const rows = res.d || [];
          if (!rows.length) {
            $("#suggestionsCards").html("<p>No suggestions yet.</p>");
            return;
          }

          let html = "";
          rows.forEach(function (s) {
            html += "<div class='item'>"
              + "<div class='small'>" + escapeHtml(s.CreatedDate || "") + "</div>"
              + "<div style='margin-top:6px;'>" + escapeHtml(s.SuggestionText || "") + "</div>"
              + "<div class='vote-actions'>"
              + "<span class='small'>üëç " + (s.UpVotes || 0) + "</span>"
              + "<span class='small'>üëé " + (s.DownVotes || 0) + "</span>"
              + "</div>"
              + "</div>";
          });

          $("#suggestionsCards").html(html);
        },
        error: function () {
          $("#suggestionsCards").html("<p>Error loading suggestions.</p>");
        }
      });
    }

    function submitSuggestion() {
      const text = ($("#suggestionText").val() || "").trim();
      if (!text) {
        $("#suggestionMsg").css("color", "#b00020").text("Suggestion cannot be empty.");
        return;
      }

      $.ajax({
        type: "POST",
        url: apiUrl("AddSuggestion"),
        contentType: "application/json; charset=utf-8",
        data: JSON.stringify({ suggestionText: text }),
        dataType: "json",
        success: function (res) {
          const data = res && res.d ? res.d : null;
          if (!data || !data.success) {
            const message = data && data.message ? data.message : "Submit failed.";
            if ((message || "").includes("logged")) {
              redirectToLogin();
              return;
            }
            if (message === "Access Denied") {
              showAccessDenied();
              return;
            }
            $("#suggestionMsg").css("color", "#b00020").text(message);
            return;
          }

          $("#suggestionMsg").css("color", "#166534").text("Suggestion submitted.");
          $("#suggestionText").val("");
          loadSuggestions();
        },
        error: function () {
          $("#suggestionMsg").css("color", "#b00020").text("Submit failed.");
        }
      });
    }

    function checkAccessAndInit() {
      $.ajax({
        type: "POST",
        url: apiUrl("GetAccessStatus"),
        contentType: "application/json; charset=utf-8",
        data: "{}",
        dataType: "json",
        success: function (res) {
          if (!res || !res.d) {
            redirectToLogin();
            return;
          }

          const access = res.d;
          if (!access.loggedIn) {
            redirectToLogin();
            return;
          }
          if (!access.verified) {
            showAccessDenied();
            return;
          }

          loadSuggestions();
          if (typeof initVotingUI === "function") {
            initVotingUI();
          }
        },
        error: function () {
          redirectToLogin();
        }
      });
    }

    function logout() {
      $.ajax({
        type: "POST",
        url: apiUrl("Logout"),
        contentType: "application/json; charset=utf-8",
        data: "{}",
        dataType: "json",
        complete: function () {
          try {
            sessionStorage.removeItem("adminPinVerified");
          } catch (e) {
          }
          window.location.href = "login.html";
        }
      });
    }

    $(document).ready(function () {
      enforceSectionOrder();
      $("#btnSubmitSuggestion").on("click", submitSuggestion);
      $("#btnAdmin").on("click", function () { window.location.href = "admin-pin.html"; });
      $("#btnLogout").on("click", logout);
      checkAccessAndInit();
    });
  </script>
</body>
</html>
